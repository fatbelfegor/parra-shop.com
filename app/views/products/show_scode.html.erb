<link rel="stylesheet" type="text/css" href="/assets/product.css">
<div id="product-page" class="show page">
	<div class="breadcrumbs">
		<a href="http://www.parra-shop.ru">Главная</a>
		<span>></span>
		<% if @product.category %>
			<% par = @product.category.parent
			while par %>
				<a href="http://www.parra-shop.ru/catalog/<%= par.url %>"><%= par.name %></a>
				<span>></span>
				<% par = par.parent
			end %>
			<a href="http://www.parra-shop.ru/catalog/<%= @product.category.url %>"><%= @product.category.name %></a>
			<span>></span>
		<% end %>
		<p><%= @product.name %></p>
	</div>
	<div class="page-title"><% if @product.category and !@product.category.header.blank? %><img src='<%= @product.category.header %>'> / <% end %><%= if @product.category then @product.category.name else @product.subcategory.name end %></div>
	<div class="product-wrap">
		<div>
			<% if @product.extension %>
				<img class='extension-show' src="<%= @product.extension.image %>">
			<% elsif $global_share %>
				<img src="<%= $global_extension.url %>" class='extension-show'>
			<% end %>
			<% images = @product.product_images.map{|i| i.image} %>
			<% if images.any?
				alt = @product.name %>
				<div class="photoes">
			    	<a class="active" href="<%= images[0].url %>" data-lightbox="images"><img alt="<%= alt %>" src="<%= images[0].big.url %>"></a>
		    		<% images[1..-1].each do |i| %>
		    			<a href="<%= i.url %>" data-lightbox="images"><img alt="<%= alt %>" src="<%= i.big.url %>"></a>
		    		<% end %>
				</div>
				<div class="mini">
					<div class="item"><img data-i='0' onclick="choosePhoto(this)" class="active" src="<%= images[0].small.url %>"></div>
					<% images[1..-1].each_with_index do |img, i| %>
						<div class="item"><img data-i='<%= i + 1 %>' onclick="choosePhoto(this)" src="<%= img.small.url %>"></div>
					<% end %>
				</div>
			<% end %>
		</div>
		<div class="productContent">
			<h1><%= @product.name %></h1>
			<div class="product-description">
			<%= raw @product.description.gsub('&nbsp;', '') %>
			</div>
			<div id="choosedChars" class="open">
				<div class="choosed-options">Выбранные опции:</div>
				<p>Размер: <b></b></p>
				<p>Цвет: <b></b></p>
				<p>Опция: <b></b></p>
			</div>
			<div class="price">
				<div class="price-block">
					<p class="old_price">Цена: <strike id='oldPrice'></strike> <img src="/assets/rublGray.png"></p>
					<p class="main">
						<b id="summaryPrice"></b> <img src="/assets/rubl.png">
					</p>
					<p class="difference">Вы экономите: <span id='pricesDifference'></span> <img src="/assets/rublGray.png"></p>
				</div>
				<div class="buyButton" onclick="addToCart('<%= @product.name %>', this)">Купить</div>
				<p style="font-size: 14px; margin: 37px 0 20px"><b>Мы принимаем к оплате:</b></p>
				<img src="/assets/grayCards.png">
				<p style="font-size: 12px; font-weight: normal; margin-top: 18px">*Держатели банковских карт перечисленных систем могут расплатиться ими в наших фирменных салонах-магазинах.</p>
				<%= hidden_field_tag :product_id_field, @product.id %>
				<%= hidden_field_tag :product_scode, @product.scode %>
			</div>
		</div>
	</div>
	<% if current_user && current_user.admin? %>
		<% @products = Product.order :position
		@prsizes = Prsize.all %>
		<div id="admin-product">
			<div>
				<%= link_to 'Редактировать', edit_product_path(@product), class: 'btn btn-warning' %>
				<%= link_to 'Удалить', @product, 'data-confirm' => 'Вы уверены?', method: :delete, class: 'btn btn-danger' %>
				<%= link_to 'Список Продуктов',   if(@product.category) then @product.category else products_path end, class: 'btn btn-info' %>
				<span class="btn btn-success" id='dropdown'>
					<p onclick='$(this).parent().toggleClass("active")'>Скопировать Размеры</p>
					<% def dropdown cats
						ret = '<ul>'
						for cat in cats
							ret += "<li><p onclick='$(this).next().toggleClass(\"active\")'>#{cat.name}</p>"
							children = @categories.find_all{|c| c.parent_id == cat.id}
							if children.blank?
								products = @products.find_all{|p| p.category_id == cat.id}
								if !products.blank?
									ret += '<ul>'
									for p in products
										ret += "<li><p>#{p.name}<a href='/copy-sizes?from=#{p.id}&to=#{@product.id}' class='btn btn-success'>Выбрать</a></p></li>"
									end
									ret += '</ul>'
								end
							else
								ret += dropdown children
							end
							ret += '</li>'
						end
						ret + '</ul>'
					end %>
					<%= raw dropdown @categories.find_all{|c| !c.parent_id} %>
				</span>
			</div>
			<br><br>
			<table>
				<tr><h2>Список размеров (<%= sizes.count %>) <%= link_to 'Создать', new_prsize_path(@product.id), class: 'btn btn-primary' %>
				<span class="btn btn-success" id='dropdown'>
					<p onclick='$(this).parent().toggleClass("active")'>Скопировать Размер</p>
					<% def dropdown cats
						ret = '<ul>'
						for cat in cats
							ret += "<li><p onclick='$(this).next().toggleClass(\"active\")'>#{cat.name}</p>"
							children = @categories.find_all{|c| c.parent_id == cat.id}
							if children.blank?
								ret += '<ul>'
								for p in @products.find_all{|p| p.category_id == cat.id}
									ret += "<li><p onclick='$(this).next().toggleClass(\"active\")'>#{p.name}</p><ul>"
									for s in @prsizes.find_all{|s| s.product_id == p.id}
										ret += "<li><p>#{s.name}<a href='/copy-size?from=#{p.id}&to=#{@product.id}' class='btn btn-success'>Выбрать</a></p></li>"
									end
									ret += "</ul></li>"
								end
								ret += '</ul>'
							else
								ret += dropdown children
							end
							ret += '</li>'
						end
						ret + '</ul>'
					end %>
					<%= raw dropdown @categories.find_all{|c| !c.parent_id} %>
				</span>
				</tr>
				<tr>
					<th>Название</th>
					<th>Старая цена</th>
					<th>Цена</th>
					<th>действия</th>
				</tr>
				<% for size in sizes %>
					<tr>
						<td><%= size.name %></td>
						<td><%= number_to_currency size.old_price %></td>
						<td><%= number_to_currency size.price %></td>
						<td>
							<%= link_to 'Удалить', size, data: {confirm: 'Вы уверены?'}, :method => :delete, class: 'btn btn-danger' %>
							<%= link_to 'Редактировать', edit_prsize_path(size), class: 'btn btn-warning' %>
							<div class="btn btn-success" onclick="sizeOpen(this)">Развернуть</div>
						</td>
					</tr>
					<tr class="color">
						<td colspan="4">
							<table class="hide">
								<tr>
									<th colspan="4"><h2>Список цветов (<%= size.prcolors.count %>) <%= link_to 'Создать', new_prcolor_path(@product.id, size.id), class: 'btn btn-primary' %> <div class="btn btn-primary" onclick="sizeSubOpen(this)">Развернуть</div></h2></th>
								</tr>
								<tr>
									<th>Название</th>
									<th>Цена</th>
									<th>действия</th>
								</tr>
								<% for color in size.prcolors %>
									<tr>
										<td><%= color.name %></td>
										<td><%= number_to_currency color.price %></td>
										<td>
											<%= link_to 'Удалить', color, :confirm => 'Вы уверены?', :method => :delete, class: 'btn btn-danger' %>
											<%= link_to 'Редактировать', "/products/#{@product.id}/prsizes/#{size.id}/prcolors/#{color.id}/edit", class: 'btn btn-warning' %> <div class="btn btn-success" onclick="colorOpen(this)">Развернуть</div>
										</td>
									</tr>
									<tr class="texture">
										<td colspan="4">
											<table class="hide">
												<tr>
													<th colspan="4"><h2>Список текстур (<%= color.textures.count %>) <%= link_to 'Создать', "/products/#{@product.id}/prsizes/#{size.id}/prcolors/#{color.id}/edit", class: 'btn btn-primary' %> <div class="btn btn-primary" onclick="sizeSubOpen(this)">Развернуть</div></h2></th>
												</tr>
												<tr>
													<th>Название</th>
													<th>Цена</th>
													<th>действия</th>
												</tr>
												<% for texture in color.textures %>
													<tr>
														<td><%= texture.name %></td>
														<td><%= number_to_currency texture.price %></td>
														<td>
															<%= link_to 'Удалить', texture, :confirm => 'Вы уверены?', :method => :delete, class: 'btn btn-danger' %>
															<%= link_to 'Редактировать', edit_texture_path(texture), class: 'btn btn-warning' %>
														</td>
													</tr>
												<% end %>
											</table>
										</td>
									</tr>
								<% end %>
							</table>
						</td>
					</tr>
					<tr class="option">
						<td colspan="4">
							<table class="hide">
								<tr>
									<th colspan="4"><h2>Список опций (<%= size.proptions.count %>) <%= link_to 'Создать', new_proption_path(@product.id, size.id), class: 'btn btn-primary' %> <div class="btn btn-primary" onclick="sizeSubOpen(this)">Развернуть</div></h2></th>
								</tr>
								<tr>
									<th>Название</th>
									<th>Цена</th>
									<th>действия</th>
								</tr>
								<% for option in size.proptions %>
									<tr>
										<td><%= option.name %></td>
										<td><%= number_to_currency option.price %></td>
										<td>
											<%= link_to 'Удалить', option, :confirm => 'Вы уверены?', :method => :delete, class: 'btn btn-danger' %>
											<%= link_to 'Редактировать', edit_proption_path(option), class: 'btn btn-success' %>
										</td>
									</tr>
								<% end %>
							</table>
						</td>
					</tr>
				<% end %>
			</table>
		</div>
	<% end %>
	<% sizes = @product.prsizes %>
	<% sizes_exist = sizes.any? %>
	<% if sizes_exist %>
		<% first_size = sizes.first %>
		<% color_exist = first_size.prcolors.any? %>
		<% option_exist = first_size.proptions.any? %>
		<div class="header">Выбрать модификацию:</div>
		<div class="tabs">
			<div onclick="tabs(this)" class="active">Размер</div>
			<% if color_exist %>
				<div onclick="tabs(this)">Цвет</div>
			<% end %>
			<% if option_exist %>
				<div onclick="tabs(this)">Другие опции</div>
			<% end %>
		</div>
		<div class="tabs-pages">
			<div class="prsizes active tab">
				<% checked = true
				for size in @product.prsizes %>
					<div onclick="sizeChoose(this)" data-old-price="<%= size.old_price %>" data-price="<%= size.price %>">
						<span data-id="<%= size.id %>" data-type="size" class="i checkbox<% if checked then checked = false %> checked<% end %>"></span>
						<span class="name"><%= size.name %></span>
					</div>
				<% end %>
			</div>
			<div class="prcolors tab">
				<% first = true %>
				<% for size in sizes %>
					<div class="size<%= if first then first = false; ' cur' end %>">
						<% if size.prcolors.blank? %>
							<div class="hint">Для этого размера цвета отсутствуют.</div>
						<% else %>
							<% checked = true
							for color in size.prcolors %>
								<% textures = color.textures
								if textures.blank? %>
									<div data-price="<%= color.price %>" class="color" onclick="checkboxClick(this)">
										<a href='<%= color.images %>' data-lightbox='<%= color.name %>'><img src="<%= color.images %>"></a>
										<p class="name">Цвет <%= color.name %></p>
										<span data-id="<%= color.id %>" data-type="color" class="i checkbox<% if checked then checked = false %> checked<% end %>"></span>
									</div>
								<% else %>
									<div class="catalog">
										<div data-price="<%= color.price %>" data-type="color" data-id="<%= color.id %>" onclick="$(this).toggleClass('open').find('i').toggleClass('color-down color-up')">
											<a href='<%= color.images %>' data-lightbox='<%= color.name %>'><img src="<%= color.images %>"></a>
											<p class="name">Каталог тканей <%= color.name %></p>
											<span class="i color-down"></span>
										</div>
										<div class="textures">
											<% for texture in textures %>
												<div data-price="<%= texture.price %>" onclick="checkboxClick(this)">
													<p class="name"><%= texture.scode %> <%= texture.name %></p>
													<a class="texture-image" href='<%= texture.image %>' data-lightbox='<%= color.name %>'><img src="<%= texture.image %>"></a>
													<span data-id="<%= texture.id %>" data-type="texture" class="i checkbox<% if checked then checked = false %> checked<% end %>"></span>
												</div>
											<% end %>
										</div>
									</div>
								<% end %>
							<% end %>
						<% end %>
					</div>
				<% end %>
			</div>
			<div class="proptions tab">
				<% first = true %>
				<% for size in sizes %>
					<div class="size<%= if first then first = false; ' cur' end %>">
						<div data-price="0" onclick="checkboxClick(this)">
							<span data-id="0" data-type="option" class="i checkbox checked"></span>
							<span class="name">Без опции</span>
						</div>
						<% for option in size.proptions %>
							<div data-price="<%= option.price %>" onclick="checkboxClick(this)">
								<span data-id="<%= option.id %>" data-type="option" class="i checkbox"></span>
								<span class="name"><%= option.name %></span>
							</div>
						<% end %>
					</div>
				<% end %>
			</div>
		</div>
	<% end %>
	<div class="others">
		<% if @product.category %>
			<p>Другие товары коллекции "<%= @product.category.name %>"</p>
			<div class="wrap"><div class="table"><%= render(:partial => "products/productFooter" , collection: @product.category.products) %></div></div>
		<% else %>
			<p>Другие товары коллекции "<%= @product.subcategory.name %>"</p>
			<div class="wrap"><div class="table"><%= render(:partial => "products/productFooter" , collection: @product.subcategory.products) %></div></div>
		<% end %>
	</div>
	<% unless @product.product_footer_images.blank? %>
		<% for footer in @product.product_footer_images %>
			<br>
			<br>
			<a href="<%= footer.image.url %>" data-lightbox="footer-images"><img style="width: 100%" src="<%= footer.image.url %>"></a>
		<% end %>
	<% end %>
	<% unless @product.seo_text.blank? %>
		<div class="seo_text">
			<%= raw @product.seo_text %>
		</div>
	<% end %>
</div>

<script type="text/javascript" src="/assets/product.js"></script>
<script type="text/javascript">
	productPage(<%= raw @product.to_json(only: [:price, :old_price], include: {prsizes: {only: :id, include: [{prcolors: {only: :id, include: {textures: {only: :id}}}, proptions: {only: :id}}]}}) %>)	
</script>

<script src="/assets/lightbox.min.js"></script>
<link href="/assets/lightbox.min.css" rel="stylesheet" />

<link rel="stylesheet" type="text/css" href="/assets/slick.min.css">
<script type="text/javascript" src="/assets/slick.min.js"></script>
<script type="text/javascript">
var w = document.body.offsetWidth;
var slides;
if (w > 505) {
	slides = 3
} else if (w > 360) {
	slides = 2
} else {
	slides = 1
}
$('.mini').slick({slidesToShow:slides,slidesToScroll:slides});
</script>